
if [is_remote target] {
    set ret [remote_exec target "uname -r"]
    set kvr [lindex $ret 1]
    set kv_a [split $kvr "-"]
    set kv [lindex $kv_a 0]
} else {
    set kvr [exec uname -r]
    set kv [exec uname -r | cut -f1 -d-]
}
# a pattern bound to match
set kr {[23]?[0-9]*}
# a pattern bound to mismatch
set krx {?noSuchKernel*}

if [is_remote target] {
    set ret [remote_exec target "uname -i"]
    set arch [lindex $ret 1]
} else {
    set arch [exec uname -i]
}
# normalize arch; PR4186
set arch [normalize_arch $arch]
set ar "?[string range $arch 1 end-1]?"
set arx {?noSuchArch?}

# This test works so that if all the preprocessor conditionals
# work as expected, stap will indicate no error.

set test "preprocessor basic ops"
eval spawn stap [stap_get_board_args] -p2 -e {"probe never {}
%( kernel_v == \"$kv\"   %? %: ERROR %)
%( kernel_v == \"$kr\"   %? %: ERROR %)
%( kernel_v == \"$krx\"   %? ERROR %: %)
%( kernel_v != \"$kv\"   %? ERROR %: %)
%( kernel_v != \"$kr\"   %? ERROR %: %)
%( kernel_v != \"$krx\"   %? %: ERROR %)
%( kernel_v < \"9.9999\"  %? %: ERROR %)
%( kernel_v <= \"9.9999\" %? %: ERROR %)
%( kernel_v > \"9.9999\"  %? ERROR %: %)
%( kernel_v >= \"9.9999\" %? ERROR %: %)
%( kernel_vr == \"$kvr\"  %? %: ERROR %)
%( kernel_vr == \"$kr\"  %? %: ERROR %)
%( kernel_vr == \"$krx\"  %? ERROR %: %)
%( kernel_vr != \"$kvr\"  %? ERROR %: %)
%( kernel_vr != \"$kr\"   %? ERROR %: %)
%( kernel_vr != \"$krx\"   %? %: ERROR %)
%( kernel_vr < \"9.9999\"  %? %: ERROR %)
%( kernel_vr <= \"9.9999\" %? %: ERROR %)
%( kernel_vr > \"9.9999\"  %? ERROR %: %)
%( kernel_vr >= \"9.9999\" %? ERROR %: %)
%( arch == \"$arch\"      %? %: ERROR %)
%( arch == \"$ar\"        %? %: ERROR %)
%( arch == \"$arx\"        %? ERROR %: %)
%( arch != \"$arch\"      %? ERROR %: %)
%( arch != \"$ar\"        %? ERROR %: %)
%( arch != \"$arx\"        %? %: ERROR %)
"}
set ok 0
expect {
    "never" { incr ok }
    eof { }
    timeout { }
}
catch {close; wait}
if {$ok == 1} { pass $test } { fail $test }
